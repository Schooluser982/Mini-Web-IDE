<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Mini Web IDE</title>

<!-- CodeMirror CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material-darker.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/eclipse.min.css">

<style>
  :root {
    --bg: #1e1e1e;
    --text: #ffffff;
    --panel-bg: #252526;
    --divider: #444;
    --devtools-height: 300px;
  }

  body.light {
    --bg: #ffffff;
    --text: #000000;
    --panel-bg: #f3f3f3;
    --divider: #cccccc;
  }

  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    height: 100vh;
    display: flex;
    flex-direction: column;
    background: var(--bg);
    color: var(--text);
    font-family: system-ui, sans-serif;
    overflow: hidden;
  }

  header {
    padding: 8px 12px;
    display: flex;
    align-items: center;
    gap: 8px;
    background: #00000040;
    border-bottom: 1px solid #00000060;
  }

  header button {
    padding: 4px 10px;
    border-radius: 4px;
    border: 1px solid #555;
    background: #333;
    color: #fff;
    cursor: pointer;
    font-size: 13px;
  }

  body.light header button {
    background: #e0e0e0;
    color: #000;
    border-color: #aaa;
  }

  header button:hover {
    filter: brightness(1.1);
  }

  #fileInput {
    display: none;
  }

  #container {
    flex: 1;
    display: flex;
    min-height: 0;
  }

  #left {
    width: 50%;
    display: flex;
    flex-direction: column;
    background: var(--panel-bg);
    min-width: 150px;
  }

  #tabs {
    display: flex;
    border-bottom: 1px solid #00000040;
    background: #00000030;
  }

  .tab {
    flex: 1;
    padding: 6px 8px;
    text-align: center;
    font-size: 13px;
    cursor: pointer;
    user-select: none;
  }

  .tab.active {
    background: #00000060;
    font-weight: 600;
  }

  #editors {
    flex: 1;
    position: relative;
  }

  .editor-wrapper {
    position: absolute;
    inset: 0;
    display: none;
  }

  .editor-wrapper.active {
    display: block;
  }

  .CodeMirror {
    height: 100%;
    font-size: 13px;
  }

  #divider {
    width: 6px;
    cursor: ew-resize;
    background: var(--divider);
  }

  #right {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 150px;
    position: relative;
    overflow: hidden;
  }

  #preview {
    flex: 1;
    border: none;
    background: white;
  }

  #console {
    height: 100px;
    background: #111;
    color: #f55;
    font-family: monospace;
    font-size: 12px;
    padding: 4px 6px;
    overflow: auto;
    border-top: 1px solid #333;
  }

  body.light #console {
    background: #f8f8f8;
    color: #b00000;
    border-top-color: #ccc;
  }

  #console-title {
    font-weight: bold;
    margin-bottom: 2px;
  }

  /* DEVTOOLS DRAWER */
  #devtools {
    position: absolute;
    left: 0;
    right: 0;
    bottom: -300px;
    height: var(--devtools-height);
    background: #111;
    color: #eee;
    border-top: 2px solid #333;
    display: flex;
    flex-direction: column;
    transition: bottom 0.35s ease;
    z-index: 20;
  }

  #devtools.open {
    bottom: 0;
  }

  #devtools-tabs {
    display: flex;
    background: #222;
    border-bottom: 1px solid #333;
  }

  .dt-tab {
    padding: 6px 10px;
    cursor: pointer;
    font-size: 12px;
    user-select: none;
  }

  .dt-tab.active {
    background: #444;
    font-weight: bold;
  }

  #devtools-content {
    flex: 1;
    overflow: auto;
    padding: 6px;
  }

  .dt-panel {
    display: none;
    white-space: pre-wrap;
    font-family: monospace;
    font-size: 12px;
  }

  .dt-panel.active {
    display: block;
  }

  /* Highlight inspected element */
  .__inspect-highlight {
    outline: 2px solid red !important;
    outline-offset: -2px !important;
  }
</style>
</head>
<body>

<header>
  <button id="runBtn">Run â–¶</button>
  <button id="saveBtn">Save</button>
  <button id="loadBtn">Load</button>
  <input type="file" id="fileInput" accept=".txt,.html,.code">
  <button id="themeBtn">Toggle Theme</button>
  <button id="devtoolsBtn">DevTools</button>
  <span style="margin-left:auto;font-size:12px;opacity:0.7;">Mini Web IDE</span>
</header>

<div id="container">
  <div id="left">
    <div id="tabs">
      <div class="tab active" data-target="html">HTML</div>
      <div class="tab" data-target="css">CSS</div>
      <div class="tab" data-target="js">JS</div>
    </div>
    <div id="editors">
      <div class="editor-wrapper active" id="html-wrapper">
        <textarea id="htmlEditor"><h1>Hello!</h1>
<p>Edit HTML, CSS, and JS, then click Run.</p></textarea>
      </div>
      <div class="editor-wrapper" id="css-wrapper">
        <textarea id="cssEditor">body {
  font-family: sans-serif;
  padding: 20px;
  background: #f0f0f0;
}
h1 {
  color: #3366ff;
}</textarea>
      </div>
      <div class="editor-wrapper" id="js-wrapper">
        <textarea id="jsEditor">console.log("Hello from JS!");
// Try causing an error to see it below:
// throw new Error("Test error");</textarea>
      </div>
    </div>
  </div>

  <div id="divider"></div>

  <div id="right">
    <iframe id="preview"></iframe>
    <div id="console">
      <div id="console-title">Console</div>
      <div id="console-output"></div>
    </div>

    <!-- DEVTOOLS DRAWER -->
    <div id="devtools">
      <div id="devtools-tabs">
        <div class="dt-tab active" data-target="dt-elements">Elements</div>
        <div class="dt-tab" data-target="dt-styles">Styles</div>
        <div class="dt-tab" data-target="dt-source">Source</div>
      </div>

      <div id="devtools-content">
        <pre id="dt-elements" class="dt-panel active"></pre>
        <pre id="dt-styles" class="dt-panel"></pre>
        <pre id="dt-source" class="dt-panel"></pre>
      </div>
    </div>
  </div>
</div>

<!-- CodeMirror JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/css/css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>

<script>
/* ---------------------------
   THEME TOGGLE
----------------------------*/
let darkTheme = true;
const themeBtn = document.getElementById("themeBtn");

function applyTheme() {
  document.body.classList.toggle("light", !darkTheme);
  const cmTheme = darkTheme ? "material-darker" : "eclipse";
  htmlCM.setOption("theme", cmTheme);
  cssCM.setOption("theme", cmTheme);
  jsCM.setOption("theme", cmTheme);
}

themeBtn.addEventListener("click", () => {
  darkTheme = !darkTheme;
  applyTheme();
});

/* ---------------------------
   CODEMIRROR EDITORS
----------------------------*/
const htmlCM = CodeMirror.fromTextArea(document.getElementById("htmlEditor"), {
  mode: "xml",
  lineNumbers: true,
  theme: "material-darker"
});

const cssCM = CodeMirror.fromTextArea(document.getElementById("cssEditor"), {
  mode: "css",
  lineNumbers: true,
  theme: "material-darker"
});

const jsCM = CodeMirror.fromTextArea(document.getElementById("jsEditor"), {
  mode: "javascript",
  lineNumbers: true,
  theme: "material-darker"
});

/* ---------------------------
   TABS
----------------------------*/
const tabs = document.querySelectorAll(".tab");
const wrappers = {
  html: document.getElementById("html-wrapper"),
  css: document.getElementById("css-wrapper"),
  js: document.getElementById("js-wrapper")
};

tabs.forEach(tab => {
  tab.addEventListener("click", () => {
    tabs.forEach(t => t.classList.remove("active"));
    tab.classList.add("active");

    Object.values(wrappers).forEach(w => w.classList.remove("active"));
    const target = tab.getAttribute("data-target");
    wrappers[target].classList.add("active");

    if (target === "html") htmlCM.refresh();
    if (target === "css") cssCM.refresh();
    if (target === "js") jsCM.refresh();
  });
});

/* ---------------------------
   RESIZABLE SPLIT
----------------------------*/
const divider = document.getElementById("divider");
const left = document.getElementById("left");
let isDragging = false;

divider.addEventListener("mousedown", () => {
  isDragging = true;
  document.body.style.cursor = "ew-resize";
});

document.addEventListener("mousemove", e => {
  if (!isDragging) return;
  const percent = (e.clientX / window.innerWidth) * 100;
  if (percent > 10 && percent < 90) {
    left.style.width = percent + "%";
    htmlCM.refresh();
    cssCM.refresh();
    jsCM.refresh();
  }
});

document.addEventListener("mouseup", () => {
  isDragging = false;
  document.body.style.cursor = "default";
});

/* ---------------------------
   CONSOLE
----------------------------*/
const consoleOutput = document.getElementById("console-output");
function clearConsole() {
  consoleOutput.textContent = "";
}
function logToConsole(msg, type = "log") {
  const line = document.createElement("div");
  line.textContent = "[" + type.toUpperCase() + "] " + msg;
  consoleOutput.appendChild(line);
  consoleOutput.scrollTop = consoleOutput.scrollHeight;
}

/* ---------------------------
   RUN / PREVIEW
----------------------------*/
const preview = document.getElementById("preview");
const runBtn = document.getElementById("runBtn");

function runCode() {
  clearConsole();
  const html = htmlCM.getValue();
  const css = cssCM.getValue();
  const js = jsCM.getValue();

  const wrappedJS = `
    (function() {
      const oldLog = console.log;
      const oldErr = console.error;
      console.log = function(...args) {
        parent.postMessage({ type: 'log', message: args.join(' ') }, '*');
        oldLog.apply(console, args);
      };
      console.error = function(...args) {
        parent.postMessage({ type: 'error', message: args.join(' ') }, '*');
        oldErr.apply(console, args);
      };
      window.onerror = function(msg, url, line, col, err) {
        parent.postMessage({ type: 'error', message: msg + ' (line ' + line + ')' }, '*');
      };
      try {
        ${js}
      } catch (e) {
        parent.postMessage({ type: 'error', message: e.toString() }, '*');
      }
    })();
  `;

  const doc = `
    <!DOCTYPE html>
    <html>
    <head>
      <style>${css}</style>
    </head>
    <body>
      ${html}
      <script>${wrappedJS}<\/script>
    </body>
    </html>
  `;

  preview.srcdoc = doc;
}

runBtn.addEventListener("click", runCode);

window.addEventListener("message", e => {
  if (!e.data || !e.data.type) return;
  if (e.data.type === "log") logToConsole(e.data.message, "log");
  if (e.data.type === "error") logToConsole(e.data.message, "error");
});

/* ---------------------------
   SAVE / LOAD
----------------------------*/
const saveBtn = document.getElementById("saveBtn");
const loadBtn = document.getElementById("loadBtn");
const fileInput = document.getElementById("fileInput");

saveBtn.addEventListener("click", () => {
  const data = {
    html: htmlCM.getValue(),
    css: cssCM.getValue(),
    js: jsCM.getValue()
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "project.txt";
  a.click();
});

loadBtn.addEventListener("click", () => fileInput.click());

fileInput.addEventListener("change", function() {
  const file = this.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const data = JSON.parse(reader.result);
      if (data.html !== undefined) htmlCM.setValue(data.html);
      if (data.css !== undefined) cssCM.setValue(data.css);
      if (data.js !== undefined) jsCM.setValue(data.js);
    } catch (e) {
      alert("Invalid file format.");
    }
  };
  reader.readAsText(file);
  this.value = "";
});

/* ---------------------------
   DEVTOOLS DRAWER
----------------------------*/
const devtools = document.getElementById("devtools");
const devtoolsBtn = document.getElementById("devtoolsBtn");

devtoolsBtn.addEventListener("click", () => {
  devtools.classList.toggle("open");
});

/* DevTools tabs */
document.querySelectorAll(".dt-tab").forEach(tab => {
  tab.addEventListener("click", () => {
    document.querySelectorAll(".dt-tab").forEach(t => t.classList.remove("active"));
    tab.classList.add("active");

    document.querySelectorAll(".dt-panel").forEach(p => p.classList.remove("active"));
    document.getElementById(tab.dataset.target).classList.add("active");
  });
});

/* Update DevTools after running code */
function updateDevTools() {
  const iframe = preview.contentDocument;

  document.getElementById("dt-elements").textContent =
    formatDOM(iframe.documentElement, 0);

  document.getElementById("dt-source").textContent =
    preview.srcdoc;
}

/* Format DOM tree */
function formatDOM(node, depth) {
  let indent = "  ".repeat(depth);
  let output = indent + "<" + node.nodeName.toLowerCase() + ">\n";

  node.childNodes.forEach(child => {
    if (child.nodeType === 1) {
      output += formatDOM(child, depth + 1);
    } else if (child.nodeType === 3 && child.textContent.trim()) {
      output += indent + "  " + child.textContent.trim() + "\n";
    }
  });

  return output;
}

/* Inspect element on click */
preview.addEventListener("load", () => {
  const doc = preview.contentDocument;

  doc.addEventListener("click", e => {
    e.preventDefault();
    e.stopPropagation();

    doc.querySelectorAll(".__inspect-highlight").forEach(el => {
      el.classList.remove("__inspect-highlight");
    });

    e.target.classList.add("__inspect-highlight");

    const styles = window.getComputedStyle(e.target);
    let styleText = "";

    for (let prop of styles) {
      styleText += `${prop}: ${styles.getPropertyValue(prop)}\n`;
    }

    document.getElementById("dt-styles").textContent = styleText;
  });
});

/* Hook into runCode */
const oldRunCode = runCode;
runCode = function() {
  oldRunCode();
  setTimeout(updateDevTools, 50);
};

/* Initial run */
runCode();
</script>

</body>
</html>
